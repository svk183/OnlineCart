"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const core_1 = require("@angular-devkit/core");
const workspace_1 = require("@nrwl/workspace");
const workspace_2 = require("@nrwl/workspace");
const init_1 = require("../init/init");
function addTypes(options) {
    const tsConfigPath = core_1.join(options.appProjectRoot, 'tsconfig.json');
    return workspace_1.updateJsonInTree(tsConfigPath, json => {
        json.compilerOptions.types = [...json.compilerOptions.types, 'express'];
        return json;
    });
}
function addMainFile(options) {
    return (host) => {
        host.overwrite(core_1.join(options.appProjectRoot, 'src/main.ts'), `/**
 * This is not a production server yet!
 * This is only a minimal backend to get started.
 */

import * as express from 'express';

const app = express();

app.get('/api', (req, res) => {
  res.send({ message: 'Welcome to ${options.name}!' });
});

const port = process.env.port || 3333;
const server = app.listen(port, () => {
  console.log(\`Listening at http://localhost:\${port}/api\`);
});
server.on('error', console.error);
`);
    };
}
function default_1(schema) {
    return (host, context) => {
        const options = normalizeOptions(schema);
        return schematics_1.chain([
            init_1.default({ skipFormat: true }),
            schematics_1.externalSchematic('@nrwl/node', 'application', schema),
            addMainFile(options),
            addTypes(options),
            workspace_2.formatFiles(options)
        ])(host, context);
    };
}
exports.default = default_1;
function normalizeOptions(options) {
    const appDirectory = options.directory
        ? `${workspace_2.toFileName(options.directory)}/${workspace_2.toFileName(options.name)}`
        : workspace_2.toFileName(options.name);
    const appProjectRoot = core_1.join(core_1.normalize('apps'), appDirectory);
    return Object.assign(Object.assign({}, options), { appProjectRoot });
}
