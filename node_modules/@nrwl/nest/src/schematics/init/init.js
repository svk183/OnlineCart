"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const workspace_1 = require("@nrwl/workspace");
const versions_1 = require("../../utils/versions");
function addDependencies() {
    return workspace_1.addDepsToPackageJson({
        '@nestjs/common': versions_1.nestJsVersion,
        '@nestjs/core': versions_1.nestJsVersion,
        '@nestjs/platform-express': versions_1.nestJsVersion,
        'reflect-metadata': versions_1.reflectMetadataVersion
    }, {
        '@nestjs/schematics': versions_1.nestJsSchematicsVersion,
        '@nestjs/testing': versions_1.nestJsVersion,
        '@nrwl/nest': versions_1.nxVersion
    });
}
exports.addDependencies = addDependencies;
function moveDependency() {
    return workspace_1.updateJsonInTree('package.json', json => {
        json.dependencies = json.dependencies || {};
        delete json.dependencies['@nrwl/nest'];
        return json;
    });
}
function setDefault() {
    return workspace_1.updateWorkspace(workspace => {
        workspace.extensions.cli = workspace.extensions.cli || {};
        const defaultCollection = workspace.extensions.cli &&
            workspace.extensions.cli.defaultCollection;
        if (!defaultCollection || defaultCollection === '@nrwl/workspace') {
            workspace.extensions.cli.defaultCollection = '@nrwl/nest';
        }
    });
}
function default_1(schema) {
    return schematics_1.chain([
        setDefault(),
        workspace_1.addPackageWithInit('@nrwl/node'),
        workspace_1.addPackageWithInit('@nrwl/jest'),
        addDependencies(),
        moveDependency(),
        workspace_1.formatFiles(schema)
    ]);
}
exports.default = default_1;
