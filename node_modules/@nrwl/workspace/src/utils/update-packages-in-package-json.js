"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ast_utils_1 = require("./ast-utils");
const fs_1 = require("fs");
function updatePackagesInPackageJson(migrationFilePath, versionName) {
    const migrations = JSON.parse(fs_1.readFileSync(migrationFilePath).toString());
    const packageJsonUpdates = migrations.packageJsonUpdates[versionName];
    // should never happen
    if (!packageJsonUpdates) {
        throw new Error(`Cannot find ${versionName} in migrations.json`);
    }
    const updatedPackages = packageJsonUpdates.packages;
    return ast_utils_1.updateJsonInTree('package.json', json => {
        Object.keys(updatedPackages).forEach(p => {
            if (json.devDependencies && json.devDependencies[p]) {
                json.devDependencies[p] = updatedPackages[p].version;
            }
            else if (json.dependencies && json.dependencies[p]) {
                json.dependencies[p] = updatedPackages[p].version;
            }
            else if (updatedPackages[p].alwaysAddToPackageJson) {
                if (!json.dependencies)
                    json.dependencies = {};
                json.dependencies[p] = updatedPackages[p].version;
            }
        });
        return json;
    });
}
exports.updatePackagesInPackageJson = updatePackagesInPackageJson;
